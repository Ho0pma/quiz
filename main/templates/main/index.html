<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
{% csrf_token %}

<!-- Authorized user -->
{% if user.is_authenticated %}
    <div id="profile-section">
        <div class="profile-header">
            <div>
                <span>{{ user.username }}</span>
                <form method="post" action="{% url 'logout' %}" style="display:inline;" onclick="event.stopPropagation();">
                    {% csrf_token %}
                    <button type="submit">Logout</button>
                </form>
            </div>
            <div id="profileInfoHeader" style="cursor: pointer;">Profile</div>
            <div id="profileInfoContent" style="display:none;">
                <div id="profileInfoDisplay">
                    <p><strong>Username:</strong> {{ user.username }}</p>
                    {% if user.email %}<p><strong>Email:</strong> {{ user.email }}</p>{% endif %}
                    <button type="button" id="profileEditBtn">Edit</button>
                </div>
                <div id="profileInfoFormWrap" style="display:none;">
                    <form id="profileEditForm" method="post" action="{% url 'main:update_profile' %}">
                        {% csrf_token %}
                        <label>Username</label>
                        <input name="username" type="text" id="profileUsername" value="{{ user.username }}" required>
                        <label>Email</label>
                        <input name="email" type="email" id="profileEmail" value="{{ user.email|default:'' }}">
                        <div id="profileEditErrors" style="color:red;"></div>
                        <button type="submit">Save</button>
                        <button type="button" id="profileEditCancel">Cancel</button>
                    </form>
                </div>
            </div>
            <div id="collectionsHeader" style="cursor: pointer;">Collections</div>
            <div id="changePasswordHeader" style="cursor: pointer;">Change password</div>
            <div id="changePasswordContent" style="display:none;">
                <form id="changePasswordForm" method="post" action="{% url 'main:change_password' %}">
                    {% csrf_token %}
                    <label>Current password</label>
                    <input name="old_password" type="password" required>
                    <label>New password</label>
                    <input name="new_password1" type="password" required>
                    <label>Confirm new password</label>
                    <input name="new_password2" type="password" required>
                    <div id="changePasswordErrors" style="color:red;"></div>
                    <button type="submit">Change password</button>
                </form>
            </div>
            <div id="studyHeader" style="cursor: pointer;">Study</div>
            <div id="studyContent" style="display:none;">
                <div id="studyChooseCollection">
                    <p>Choose collection</p>
                    {% for c in collections %}
                        {% if c.cards.all %}
                        <button type="button" class="study-pick-collection" data-collection-id="{{ c.id }}">{{ c.name }}</button>
                        {% endif %}
                    {% empty %}
                    <p>No collections with cards yet.</p>
                    {% endfor %}
                </div>
                <div id="studyCardArea" style="display:none;">
                    <div id="studyCardFrame" style="cursor: pointer; border: 1px solid #ccc; padding: 1em; min-height: 120px;">
                        <div id="studyCardFront">
                            <div id="studyCardQuestion"></div>
                            <img id="studyCardPhoto" src="" alt="" style="max-width: 200px; display: none;">
                        </div>
                        <div id="studyCardBack" style="display: none;">
                            <div id="studyCardAnswer"></div>
                        </div>
                    </div>
                    <div>
                        <button type="button" id="studyBtnWrong">✗</button>
                        <button type="button" id="studyBtnRight">✓</button>
                    </div>
                    <button type="button" id="studyBackToCollections">Back to collections</button>
                </div>
            </div>
            <script type="application/json" id="studyDataJson">{{ study_data|default:"{}"|safe }}</script>
        </div>
        <div class="profile-content" id="collectionsContent" style="display:none;">
            <!-- Collections -->
            <h2>My Collections</h2>
            <button type="button" id="openCreateCollection">Create Collection</button>
    
            {% if collections %}
                <div id="collections-container">
            {% for collection in collections %}
                <div class="collection-item" data-collection-id="{{ collection.id }}" style="cursor: pointer;">
                    <div class="collection-header">
                        <strong>{{ collection.name }}</strong> (click to expand)
                        <button type="button" class="edit-collection-btn" data-collection-id="{{ collection.id }}" data-collection-name="{{ collection.name }}" data-collection-description="{{ collection.description|default:'' }}" onclick="event.stopPropagation();">Edit</button>
                        <button type="button" class="delete-collection-btn" data-collection-id="{{ collection.id }}" onclick="event.stopPropagation();">Delete</button>
                    </div>
                    <div class="collection-content" style="display:none;">
                        {% if collection.description %}
                            <div class="collection-description">{{ collection.description }}</div>
                        {% else %}
                            <div class="collection-description">No description</div>
                        {% endif %}
                        <div class="collection-date">Created: {{ collection.created_at|date:"M d, Y" }}</div>
                        <div class="collection-cards">
                            <strong>Cards:</strong>
                            <button type="button" class="add-card-btn" data-collection-id="{{ collection.id }}" onclick="event.stopPropagation();">Add card</button>
                            {% for card in collection.cards.all %}
                                <div class="card-item" data-card-id="{{ card.id }}">
                                    <div class="card-header" style="cursor: pointer;">Card #{{ forloop.counter }}</div>
                                    <div class="card-content" style="display:none;">
                                        <div><strong>Q:</strong> {{ card.question }}</div>
                                        {% if card.photo %}
                                            <img src="{{ card.photo.url }}" alt="" width="150">
                                        {% endif %}
                                        <div><strong>A:</strong> {{ card.answer }}</div>
                                        <button type="button" class="edit-card-btn" data-card-id="{{ card.id }}" data-question="{{ card.question }}" data-answer="{{ card.answer }}" data-has-photo="{% if card.photo %}true{% else %}false{% endif %}" onclick="event.stopPropagation();">Edit</button>
                                        <button type="button" class="delete-card-btn" data-card-id="{{ card.id }}" onclick="event.stopPropagation();">Delete</button>
                                    </div>
                                </div>
                            {% empty %}
                                <p>No cards yet.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
            {% else %}
                <p>No collections yet.</p>
            {% endif %}
        </div>
    </div>
{% else %}
    <button type="button" id="openLogin">Sign in</button>
{% endif %}

<!-- Модальное окно регистрации -->
<div id="signupModal" style="display:none;">
    <div>
        <button type="button" id="closeSignup">X</button>

        <div id="signupErrors" style="color:red;"></div>

        <form id="signupForm" method="post" action="{% url 'main:signup_ajax' %}">
            {% csrf_token %}
            <input name="email" type="email" placeholder="email" required>
            <input name="username" type="text" placeholder="nickname" required>
            <input name="password1" type="password" placeholder="password" required>
            <input name="password2" type="password" placeholder="confirm password" required>
            <button type="submit">Create account</button>
            <button type="button" id="switchToLogin">I already have an account</button>
            <button type="button" id="closeSignupBtn">Close</button>
        </form>
    </div>
</div>

<!-- Модальное окно входа -->
<div id="loginModal" style="display:none;">
    <div>
        <button type="button" id="closeLogin">X</button>

        <div id="loginErrors" style="color:red;"></div>

        <form id="loginForm" method="post" action="{% url 'main:login_ajax' %}">
            {% csrf_token %}
            <input name="username" type="text" placeholder="nickname or email" required>
            <input name="password" type="password" placeholder="password" required>
            <button type="submit">Log in</button>
            <button type="button" id="switchToSignup">Create account</button>
            <button type="button" id="closeLoginBtn">Close</button>
        </form>
        <button type="button" id="forgotPasswordBtn">Forgot your password?</button>
        <div id="forgotPasswordWrap" style="display:none;">
            <p>Enter your email to receive a reset link.</p>
            <form id="forgotPasswordForm" method="post" action="{% url 'main:forgot_password' %}">
                {% csrf_token %}
                <input name="email" type="email" placeholder="email" required>
                <button type="submit">Send reset link</button>
                <button type="button" id="forgotPasswordCancel">Back</button>
            </form>
            <div id="forgotPasswordMessage" style="color:green;"></div>
        </div>
    </div>
</div>

<!-- Create Collection Modal -->
<div id="createCollectionModal" style="display:none;">
    <div>
        <button type="button" id="closeCreateCollection">X</button>
        <div id="createCollectionErrors" style="color:red;"></div>
        <form id="createCollectionForm" method="post" action="{% url 'main:create_collection' %}">
            {% csrf_token %}
            <input name="name" type="text" placeholder="Collection name" required>
            <textarea name="description" placeholder="Description (optional)"></textarea>
            <button type="submit">Create</button>
            <button type="button" id="closeCreateCollectionBtn">Close</button>
        </form>
    </div>
</div>

<!-- Edit Collection Modal -->
<div id="editCollectionModal" style="display:none;">
    <div>
        <button type="button" id="closeEditCollection">X</button>
        <div id="editCollectionErrors" style="color:red;"></div>
        <form id="editCollectionForm" method="post">
            {% csrf_token %}
            <input name="name" type="text" id="editCollectionName" placeholder="Collection name" required>
            <textarea name="description" id="editCollectionDescription" placeholder="Description (optional)"></textarea>
            <button type="submit">Update</button>
            <button type="button" id="closeEditCollectionBtn">Close</button>
        </form>
    </div>
</div>

<!-- Create Card Modal -->
<div id="createCardModal" style="display:none;">
    <div>
        <button type="button" id="closeCreateCard">X</button>
        <div id="createCardErrors" style="color:red;"></div>
        <form id="createCardForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label>Question</label>
            <textarea name="question" id="createCardQuestion" required></textarea>
            <label>Photo (optional)</label>
            <input name="photo" type="file" id="createCardPhoto" accept="image/*">
            <label>Answer</label>
            <textarea name="answer" id="createCardAnswer" required></textarea>
            <button type="submit">Create</button>
            <button type="button" id="closeCreateCardBtn">Close</button>
        </form>
    </div>
</div>

<!-- Edit Card Modal -->
<div id="editCardModal" style="display:none;">
    <div>
        <button type="button" id="closeEditCard">X</button>
        <div id="editCardErrors" style="color:red;"></div>
        <form id="editCardForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label>Question</label>
            <textarea name="question" id="editCardQuestion" required></textarea>
            <label>Photo (leave empty to keep current)</label>
            <input name="photo" type="file" id="editCardPhoto" accept="image/*">
            <div id="editCardClearPhotoWrap" style="display:none;">
                <label><input type="checkbox" name="clear_photo" id="editCardClearPhoto" value="1"> Remove photo</label>
            </div>
            <label>Answer</label>
            <textarea name="answer" id="editCardAnswer" required></textarea>
            <button type="submit">Update</button>
            <button type="button" id="closeEditCardBtn">Close</button>
        </form>
    </div>
</div>

<script>
    // Элементы DOM
    const modal = document.getElementById('signupModal');
    const errorsBox = document.getElementById('signupErrors');
    const form = document.getElementById('signupForm');
    const loginModal = document.getElementById('loginModal');
    const loginErrorsBox = document.getElementById('loginErrors');
    const loginForm = document.getElementById('loginForm');

    // Закрытие модалки регистрации (кнопка X)
    const closeSignupBtn = document.getElementById('closeSignup');
    if (closeSignupBtn) {
        closeSignupBtn.onclick = () => {
            modal.style.display = 'none';
            loginModal.style.display = 'none';
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = false;
        };
    }
    
    // Переключение с регистрации на вход
    const switchToLoginBtn = document.getElementById('switchToLogin');
    if (switchToLoginBtn) {
        switchToLoginBtn.onclick = () => {
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = true;
            modal.style.display = 'none';
            errorsBox.innerHTML = '';
            loginModal.style.display = 'block';
            loginErrorsBox.innerHTML = '';
        };
    }

    // Переключение с входа на регистрацию
    const switchToSignupBtn = document.getElementById('switchToSignup');
    if (switchToSignupBtn) {
        switchToSignupBtn.onclick = () => {
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = true;
            loginModal.style.display = 'none';
            loginErrorsBox.innerHTML = '';
            modal.style.display = 'block';
            errorsBox.innerHTML = '';
        };
    }

    // Отправка формы регистрации (AJAX)
    if (form) {
        form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorsBox.innerHTML = '';

        const resp = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            window.location.reload();
            return;
        }

        const errors = data.errors || {};
        errorsBox.innerHTML = Object.entries(errors)
            .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
            .join('');
        });
    }

    // Открытие модалки входа
    const openLoginBtn = document.getElementById('openLogin');
    if (openLoginBtn) {
        openLoginBtn.onclick = () => {
            openLoginBtn.disabled = true;
            modal.style.display = 'none';
            errorsBox.innerHTML = '';
            loginErrorsBox.innerHTML = '';
            loginModal.style.display = 'block';
        };
    }
    
    // Закрытие модалки входа (кнопка X)
    const closeLoginBtn = document.getElementById('closeLogin');
    if (closeLoginBtn) {
        closeLoginBtn.onclick = () => {
            loginModal.style.display = 'none';
            modal.style.display = 'none';
            const forgotWrap = document.getElementById('forgotPasswordWrap');
            if (forgotWrap) forgotWrap.style.display = 'none';
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = false;
        };
    }
    // Forgot password
    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
    const forgotPasswordWrap = document.getElementById('forgotPasswordWrap');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const forgotPasswordMessage = document.getElementById('forgotPasswordMessage');
    const forgotPasswordCancel = document.getElementById('forgotPasswordCancel');
    if (forgotPasswordBtn && forgotPasswordWrap) {
        forgotPasswordBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            forgotPasswordWrap.style.display = 'block';
            if (forgotPasswordMessage) forgotPasswordMessage.textContent = '';
        });
    }
    if (forgotPasswordCancel && forgotPasswordWrap) {
        forgotPasswordCancel.addEventListener('click', () => {
            forgotPasswordWrap.style.display = 'none';
            if (forgotPasswordMessage) forgotPasswordMessage.textContent = '';
        });
    }
    if (forgotPasswordForm) {
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (forgotPasswordMessage) forgotPasswordMessage.textContent = '';
            const resp = await fetch(forgotPasswordForm.action, {
                method: 'POST',
                body: new FormData(forgotPasswordForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                if (forgotPasswordMessage) forgotPasswordMessage.textContent = "If an account exists with that email, we've sent a reset link.";
                forgotPasswordForm.reset();
                return;
            }
            const errors = data.errors || {};
            if (forgotPasswordMessage) {
                forgotPasswordMessage.style.color = 'red';
                forgotPasswordMessage.textContent = Object.entries(errors).map(([f, msgs]) => msgs.join(', ')).join(' ');
            }
        });
    }
    
    // Закрытие модалки регистрации (кнопка Close)
    const closeSignupBtn2 = document.getElementById('closeSignupBtn');
    if (closeSignupBtn2) {
        closeSignupBtn2.onclick = () => {
            modal.style.display = 'none';
            loginModal.style.display = 'none';
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = false;
        };
    }

    // Закрытие модалки входа (кнопка Close)
    const closeLoginBtn2 = document.getElementById('closeLoginBtn');
    if (closeLoginBtn2) {
        closeLoginBtn2.onclick = () => {
            loginModal.style.display = 'none';
            modal.style.display = 'none';
            const fw = document.getElementById('forgotPasswordWrap');
            if (fw) fw.style.display = 'none';
            const openLoginBtn = document.getElementById('openLogin');
            if (openLoginBtn) openLoginBtn.disabled = false;
        };
    }
    
    // Отправка формы входа (AJAX)
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginErrorsBox.innerHTML = '';

        const resp = await fetch(loginForm.action, {
            method: 'POST',
            body: new FormData(loginForm),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            window.location.reload();
            return;
        }

        const errors = data.errors || {};
        loginErrorsBox.innerHTML = Object.entries(errors)
            .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
            .join('');
        });
    }

    // Profile info expand/collapse
    const profileInfoHeader = document.getElementById('profileInfoHeader');
    const profileInfoContent = document.getElementById('profileInfoContent');
    if (profileInfoHeader && profileInfoContent) {
        profileInfoHeader.addEventListener('click', () => {
            profileInfoContent.style.display = (profileInfoContent.style.display === 'none' || profileInfoContent.style.display === '') ? 'block' : 'none';
        });
    }
    // Profile edit
    const profileEditBtn = document.getElementById('profileEditBtn');
    const profileInfoDisplay = document.getElementById('profileInfoDisplay');
    const profileInfoFormWrap = document.getElementById('profileInfoFormWrap');
    const profileEditForm = document.getElementById('profileEditForm');
    const profileEditErrors = document.getElementById('profileEditErrors');
    const profileEditCancel = document.getElementById('profileEditCancel');
    if (profileEditBtn && profileInfoDisplay && profileInfoFormWrap) {
        profileEditBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileInfoDisplay.style.display = 'none';
            profileInfoFormWrap.style.display = 'block';
            if (profileEditErrors) profileEditErrors.innerHTML = '';
        });
    }
    if (profileEditCancel && profileInfoDisplay && profileInfoFormWrap) {
        profileEditCancel.addEventListener('click', (e) => {
            e.stopPropagation();
            profileInfoFormWrap.style.display = 'none';
            profileInfoDisplay.style.display = 'block';
            if (profileEditErrors) profileEditErrors.innerHTML = '';
        });
    }
    if (profileEditForm) {
        profileEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (profileEditErrors) profileEditErrors.innerHTML = '';
            const resp = await fetch(profileEditForm.action, {
                method: 'POST',
                body: new FormData(profileEditForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                window.location.reload();
                return;
            }
            const errors = data.errors || {};
            if (profileEditErrors) {
                profileEditErrors.innerHTML = Object.entries(errors)
                    .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                    .join('');
            }
        });
    }
    // Collections expand/collapse
    const collectionsHeader = document.getElementById('collectionsHeader');
    const collectionsContent = document.getElementById('collectionsContent');
    if (collectionsHeader && collectionsContent) {
        collectionsHeader.addEventListener('click', () => {
            collectionsContent.style.display = (collectionsContent.style.display === 'none' || collectionsContent.style.display === '') ? 'block' : 'none';
        });
    }
    // Change password expand/collapse and submit
    const changePasswordHeader = document.getElementById('changePasswordHeader');
    const changePasswordContent = document.getElementById('changePasswordContent');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const changePasswordErrors = document.getElementById('changePasswordErrors');
    if (changePasswordHeader && changePasswordContent) {
        changePasswordHeader.addEventListener('click', () => {
            changePasswordContent.style.display = (changePasswordContent.style.display === 'none' || changePasswordContent.style.display === '') ? 'block' : 'none';
            if (changePasswordErrors) changePasswordErrors.innerHTML = '';
        });
    }
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (changePasswordErrors) changePasswordErrors.innerHTML = '';
            const resp = await fetch(changePasswordForm.action, {
                method: 'POST',
                body: new FormData(changePasswordForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                changePasswordForm.reset();
                if (changePasswordErrors) changePasswordErrors.innerHTML = '<span style="color:green;">Password changed.</span>';
                return;
            }
            const errors = data.errors || {};
            if (changePasswordErrors) {
                changePasswordErrors.innerHTML = Object.entries(errors)
                    .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                    .join('');
            }
        });
    }

    // Study
    const studyHeader = document.getElementById('studyHeader');
    const studyContent = document.getElementById('studyContent');
    const studyChooseCollection = document.getElementById('studyChooseCollection');
    const studyCardArea = document.getElementById('studyCardArea');
    const studyCardFrame = document.getElementById('studyCardFrame');
    const studyCardFront = document.getElementById('studyCardFront');
    const studyCardBack = document.getElementById('studyCardBack');
    const studyCardQuestion = document.getElementById('studyCardQuestion');
    const studyCardPhoto = document.getElementById('studyCardPhoto');
    const studyCardAnswer = document.getElementById('studyCardAnswer');
    const studyBtnWrong = document.getElementById('studyBtnWrong');
    const studyBtnRight = document.getElementById('studyBtnRight');
    const studyBackToCollections = document.getElementById('studyBackToCollections');

    if (studyHeader && studyContent) {
        studyHeader.addEventListener('click', () => {
            studyContent.style.display = (studyContent.style.display === 'none' || studyContent.style.display === '') ? 'block' : 'none';
        });
    }

    let studyCards = [];
    let studyIndex = 0;
    let studyShowingBack = false;

    function studyShuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    function studyShowCard() {
        if (studyCards.length === 0) return;
        const card = studyCards[studyIndex];
        studyCardQuestion.textContent = card.q;
        studyCardAnswer.textContent = card.a;
        if (card.p) {
            studyCardPhoto.src = card.p;
            studyCardPhoto.style.display = '';
        } else {
            studyCardPhoto.style.display = 'none';
        }
        studyCardFront.style.display = '';
        studyCardBack.style.display = 'none';
        studyShowingBack = false;
    }

    function studyNextCard() {
        studyIndex = (studyIndex + 1) % studyCards.length;
        studyShowCard();
    }

    document.querySelectorAll('.study-pick-collection').forEach(btn => {
        btn.addEventListener('click', () => {
            const el = document.getElementById('studyDataJson');
            const studyData = el ? JSON.parse(el.textContent || '{}') : {};
            const cid = btn.getAttribute('data-collection-id');
            const col = studyData[cid];
            if (!col || !col.cards || col.cards.length === 0) return;
            studyCards = studyShuffle([...col.cards]);
            studyIndex = 0;
            studyChooseCollection.style.display = 'none';
            studyCardArea.style.display = 'block';
            studyShowCard();
        });
    });

    if (studyCardFrame) {
        studyCardFrame.addEventListener('click', () => {
            if (studyCards.length === 0) return;
            studyShowingBack = !studyShowingBack;
            studyCardFront.style.display = studyShowingBack ? 'none' : '';
            studyCardBack.style.display = studyShowingBack ? '' : 'none';
        });
    }

    if (studyBtnWrong) studyBtnWrong.addEventListener('click', (e) => { e.stopPropagation(); studyNextCard(); });
    if (studyBtnRight) studyBtnRight.addEventListener('click', (e) => { e.stopPropagation(); studyNextCard(); });

    if (studyBackToCollections) {
        studyBackToCollections.addEventListener('click', () => {
            studyCardArea.style.display = 'none';
            studyChooseCollection.style.display = 'block';
        });
    }

    // Expandable collections - using event delegation
    const collectionsContainer = document.getElementById('collections-container');
    if (collectionsContainer) {
        collectionsContainer.addEventListener('click', (e) => {
            // Don't expand if clicking delete, edit collection, edit card, delete card, or add card button
            if (e.target.classList.contains('delete-collection-btn') || e.target.classList.contains('edit-collection-btn') || e.target.classList.contains('edit-card-btn') || e.target.classList.contains('delete-card-btn') || e.target.classList.contains('add-card-btn')) {
                return;
            }
            // Click on card header: toggle card content only, don't toggle collection
            const cardHeader = e.target.closest('.card-header');
            if (cardHeader) {
                e.stopPropagation();
                const cardItem = cardHeader.closest('.card-item');
                const cardContent = cardItem && cardItem.querySelector('.card-content');
                if (cardContent) {
                    cardContent.style.display = (cardContent.style.display === 'none' || cardContent.style.display === '') ? 'block' : 'none';
                }
                return;
            }
            // Click on collection: toggle collection content
            const item = e.target.closest('.collection-item');
            if (item) {
                const content = item.querySelector('.collection-content');
                if (content) {
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                    } else {
                        content.style.display = 'none';
                    }
                }
            }
        });
    }

    // Create Collection Modal
    const createCollectionModal = document.getElementById('createCollectionModal');
    const createCollectionErrors = document.getElementById('createCollectionErrors');
    const createCollectionForm = document.getElementById('createCollectionForm');
    const openCreateCollectionBtn = document.getElementById('openCreateCollection');

    if (openCreateCollectionBtn) {
        openCreateCollectionBtn.onclick = () => {
            createCollectionErrors.innerHTML = '';
            createCollectionModal.style.display = 'block';
        };
    }

    const closeCreateCollectionBtn = document.getElementById('closeCreateCollection');
    if (closeCreateCollectionBtn) {
        closeCreateCollectionBtn.onclick = () => {
            createCollectionModal.style.display = 'none';
            createCollectionErrors.innerHTML = '';
        };
    }

    const closeCreateCollectionBtn2 = document.getElementById('closeCreateCollectionBtn');
    if (closeCreateCollectionBtn2) {
        closeCreateCollectionBtn2.onclick = () => {
            createCollectionModal.style.display = 'none';
            createCollectionErrors.innerHTML = '';
        };
    }

    // Submit create collection form
    if (createCollectionForm) {
        createCollectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            createCollectionErrors.innerHTML = '';

            const resp = await fetch(createCollectionForm.action, {
                method: 'POST',
                body: new FormData(createCollectionForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });

            const data = await resp.json();

            if (resp.ok && data.ok) {
                window.location.reload();
                return;
            }

            const errors = data.errors || {};
            createCollectionErrors.innerHTML = Object.entries(errors)
                .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                .join('');
        });
    }

    // Edit Collection Modal
    const editCollectionModal = document.getElementById('editCollectionModal');
    const editCollectionErrors = document.getElementById('editCollectionErrors');
    const editCollectionForm = document.getElementById('editCollectionForm');
    const editCollectionName = document.getElementById('editCollectionName');
    const editCollectionDescription = document.getElementById('editCollectionDescription');

    // Edit collection buttons
    document.querySelectorAll('.edit-collection-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const collectionId = btn.getAttribute('data-collection-id');
            const collectionName = btn.getAttribute('data-collection-name');
            const collectionDescription = btn.getAttribute('data-collection-description');
            
            editCollectionName.value = collectionName;
            editCollectionDescription.value = collectionDescription;
            editCollectionForm.action = `/collections/${collectionId}/update/`;
            editCollectionErrors.innerHTML = '';
            editCollectionModal.style.display = 'block';
        });
    });

    const closeEditCollectionBtn = document.getElementById('closeEditCollection');
    if (closeEditCollectionBtn) {
        closeEditCollectionBtn.onclick = () => {
            editCollectionModal.style.display = 'none';
            editCollectionErrors.innerHTML = '';
        };
    }

    const closeEditCollectionBtn2 = document.getElementById('closeEditCollectionBtn');
    if (closeEditCollectionBtn2) {
        closeEditCollectionBtn2.onclick = () => {
            editCollectionModal.style.display = 'none';
            editCollectionErrors.innerHTML = '';
        };
    }

    // Create Card Modal
    const createCardModal = document.getElementById('createCardModal');
    const createCardErrors = document.getElementById('createCardErrors');
    const createCardForm = document.getElementById('createCardForm');
    const createCardQuestion = document.getElementById('createCardQuestion');
    const createCardAnswer = document.getElementById('createCardAnswer');
    const createCardPhoto = document.getElementById('createCardPhoto');

    document.querySelectorAll('.add-card-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const collectionId = btn.getAttribute('data-collection-id');
            createCardForm.action = `/collections/${collectionId}/cards/create/`;
            createCardQuestion.value = '';
            createCardAnswer.value = '';
            createCardPhoto.value = '';
            createCardErrors.innerHTML = '';
            createCardModal.style.display = 'block';
        });
    });

    const closeCreateCardBtn = document.getElementById('closeCreateCard');
    if (closeCreateCardBtn) {
        closeCreateCardBtn.onclick = () => {
            createCardModal.style.display = 'none';
            createCardErrors.innerHTML = '';
        };
    }
    const closeCreateCardBtn2 = document.getElementById('closeCreateCardBtn');
    if (closeCreateCardBtn2) {
        closeCreateCardBtn2.onclick = () => {
            createCardModal.style.display = 'none';
            createCardErrors.innerHTML = '';
        };
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
    function escapeAttr(s) {
        return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    if (createCardForm) {
        createCardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            createCardErrors.innerHTML = '';
            const resp = await fetch(createCardForm.action, {
                method: 'POST',
                body: new FormData(createCardForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                const m = createCardForm.action.match(/\/collections\/(\d+)\/cards\/create\/$/);
                const collectionId = m ? m[1] : null;
                if (collectionId) {
                    const container = document.querySelector(`.collection-item[data-collection-id="${collectionId}"] .collection-cards`);
                    if (container) {
                        const noCards = container.querySelector('p');
                        if (noCards && noCards.textContent.trim() === 'No cards yet.') noCards.remove();
                        const cardItems = container.querySelectorAll('.card-item');
                        const nextNum = cardItems.length + 1;
                        const photoHtml = data.photo_url ? `<img src="${escapeAttr(data.photo_url)}" alt="" width="150">` : '';
                        const cardEl = document.createElement('div');
                        cardEl.className = 'card-item';
                        cardEl.dataset.cardId = data.id;
                        cardEl.innerHTML = `
                            <div class="card-header" style="cursor: pointer;">Card #${nextNum}</div>
                            <div class="card-content" style="display:none;">
                                <div><strong>Q:</strong> <span class="card-q">${escapeHtml(data.question)}</span></div>
                                ${photoHtml ? `<span class="card-photo-wrap">${photoHtml}</span>` : ''}
                                <div><strong>A:</strong> <span class="card-a">${escapeHtml(data.answer)}</span></div>
                                <button type="button" class="edit-card-btn" data-card-id="${data.id}" data-question="${escapeAttr(data.question)}" data-answer="${escapeAttr(data.answer)}" data-has-photo="${data.photo_url ? 'true' : 'false'}" onclick="event.stopPropagation();">Edit</button>
                                <button type="button" class="delete-card-btn" data-card-id="${data.id}" onclick="event.stopPropagation();">Delete</button>
                            </div>
                        `;
                        container.appendChild(cardEl);
                    }
                }
                createCardQuestion.value = '';
                createCardAnswer.value = '';
                createCardPhoto.value = '';
                createCardErrors.innerHTML = '';
                return;
            }
            const errors = data.errors || {};
            createCardErrors.innerHTML = Object.entries(errors)
                .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                .join('');
        });
    }

    // Edit Card Modal
    const editCardModal = document.getElementById('editCardModal');
    const editCardErrors = document.getElementById('editCardErrors');
    const editCardForm = document.getElementById('editCardForm');
    const editCardQuestion = document.getElementById('editCardQuestion');
    const editCardAnswer = document.getElementById('editCardAnswer');
    const editCardPhoto = document.getElementById('editCardPhoto');

    const editCardClearPhotoWrap = document.getElementById('editCardClearPhotoWrap');
    const editCardClearPhoto = document.getElementById('editCardClearPhoto');

    if (collectionsContainer) {
        collectionsContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-card-btn');
            if (editBtn) {
                e.stopPropagation();
                const cardId = editBtn.getAttribute('data-card-id');
                const question = editBtn.getAttribute('data-question') || '';
                const answer = editBtn.getAttribute('data-answer') || '';
                const hasPhoto = editBtn.getAttribute('data-has-photo') === 'true';
                editCardForm.action = `/cards/${cardId}/update/`;
                editCardQuestion.value = question;
                editCardAnswer.value = answer;
                editCardPhoto.value = '';
                if (editCardClearPhoto) editCardClearPhoto.checked = false;
                if (editCardClearPhotoWrap) editCardClearPhotoWrap.style.display = hasPhoto ? 'block' : 'none';
                editCardErrors.innerHTML = '';
                editCardModal.style.display = 'block';
            }
        });
    }

    const closeEditCardBtn = document.getElementById('closeEditCard');
    if (closeEditCardBtn) {
        closeEditCardBtn.onclick = () => {
            editCardModal.style.display = 'none';
            editCardErrors.innerHTML = '';
        };
    }
    const closeEditCardBtn2 = document.getElementById('closeEditCardBtn');
    if (closeEditCardBtn2) {
        closeEditCardBtn2.onclick = () => {
            editCardModal.style.display = 'none';
            editCardErrors.innerHTML = '';
        };
    }

    if (editCardForm) {
        editCardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editCardErrors.innerHTML = '';
            const resp = await fetch(editCardForm.action, {
                method: 'POST',
                body: new FormData(editCardForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                window.location.reload();
                return;
            }
            const errors = data.errors || {};
            editCardErrors.innerHTML = Object.entries(errors)
                .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                .join('');
        });
    }

    // Delete card (delegated)
    if (collectionsContainer) {
        collectionsContainer.addEventListener('click', async (e) => {
            const delBtn = e.target.closest('.delete-card-btn');
            if (!delBtn) return;
            e.stopPropagation();
            if (!confirm('Delete this card?')) return;
            const cardId = delBtn.getAttribute('data-card-id');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            const resp = await fetch(`/cards/${cardId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken ? csrfToken.value : ''
                },
            });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                const cardItem = delBtn.closest('.card-item');
                const cardsContainer = cardItem && cardItem.parentElement;
                if (cardItem) cardItem.remove();
                if (cardsContainer && cardsContainer.classList.contains('collection-cards') && !cardsContainer.querySelector('.card-item')) {
                    const p = document.createElement('p');
                    p.textContent = 'No cards yet.';
                    cardsContainer.appendChild(p);
                }
            } else {
                alert('Error deleting card');
            }
        });
    }

    // Submit edit collection form
    if (editCollectionForm) {
        editCollectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editCollectionErrors.innerHTML = '';

            const resp = await fetch(editCollectionForm.action, {
                method: 'POST',
                body: new FormData(editCollectionForm),
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });

            const data = await resp.json();

            if (resp.ok && data.ok) {
                window.location.reload();
                return;
            }

            const errors = data.errors || {};
            editCollectionErrors.innerHTML = Object.entries(errors)
                .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
                .join('');
        });
    }

    // Delete collection
    document.querySelectorAll('.delete-collection-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!confirm('Are you sure you want to delete this collection?')) {
                return;
            }

            const collectionId = btn.getAttribute('data-collection-id');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            const resp = await fetch(`/collections/${collectionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken ? csrfToken.value : ''
                },
            });

            const data = await resp.json();
            if (resp.ok && data.ok) {
                window.location.reload();
            } else {
                alert('Error deleting collection');
            }
        });
    });
</script>

</body>
</html>
