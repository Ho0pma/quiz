<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<!-- Authorized user -->
{% if user.is_authenticated %}
    <div>{{ user.username }}</div>

    <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <!-- Collections -->
    <h2>My Collections</h2>
    {% if collections %}
        <ul>
            {% for collection in collections %}
                <li>
                    <h3>{{ collection.name }}</h3>
                    {% if collection.description %}
                        <p>{{ collection.description }}</p>
                    {% endif %}
                    <small>Created: {{ collection.created_at|date:"M d, Y" }}</small>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No collections yet.</p>
    {% endif %}
{% else %}
    <button type="button" id="openLogin">Sign in</button>
{% endif %}

<!-- Модальное окно регистрации -->
<div id="signupModal" style="display:none;">
    <div>
        <button type="button" id="closeSignup">X</button>

        <div id="signupErrors" style="color:red;"></div>

        <form id="signupForm" method="post" action="{% url 'main:signup_ajax' %}">
            {% csrf_token %}
            <input name="email" type="email" placeholder="email" required>
            <input name="username" type="text" placeholder="nickname" required>
            <input name="password1" type="password" placeholder="password" required>
            <input name="password2" type="password" placeholder="confirm password" required>
            <button type="submit">Create account</button>
            <button type="button" id="switchToLogin">I already have an account</button>
            <button type="button" id="closeSignupBtn">Close</button>
        </form>
    </div>
</div>

<!-- Модальное окно входа -->
<div id="loginModal" style="display:none;">
    <div>
        <button type="button" id="closeLogin">X</button>

        <div id="loginErrors" style="color:red;"></div>

        <form id="loginForm" method="post" action="{% url 'main:login_ajax' %}">
            {% csrf_token %}
            <input name="username" type="text" placeholder="nickname" required>
            <input name="password" type="password" placeholder="password" required>
            <button type="submit">Log in</button>
            <button type="button" id="switchToSignup">Create account</button>
            <button type="button" id="closeLoginBtn">Close</button>
        </form>
    </div>
</div>

<script>
    // Элементы DOM
    const modal = document.getElementById('signupModal');
    const errorsBox = document.getElementById('signupErrors');
    const form = document.getElementById('signupForm');
    const loginModal = document.getElementById('loginModal');
    const loginErrorsBox = document.getElementById('loginErrors');
    const loginForm = document.getElementById('loginForm');

    // Закрытие модалки регистрации (кнопка X)
    document.getElementById('closeSignup').onclick = () => {
        modal.style.display = 'none';
        loginModal.style.display = 'none';
        document.getElementById('openLogin').disabled = false;
    };
    
    // Переключение с регистрации на вход
    document.getElementById('switchToLogin').onclick = () => {
        document.getElementById('openLogin').disabled = true;
        modal.style.display = 'none';
        errorsBox.innerHTML = '';
        loginModal.style.display = 'block';
        loginErrorsBox.innerHTML = '';
    };

    // Переключение с входа на регистрацию
    document.getElementById('switchToSignup').onclick = () => {
        document.getElementById('openLogin').disabled = true;
        loginModal.style.display = 'none';
        loginErrorsBox.innerHTML = '';
        modal.style.display = 'block';
        errorsBox.innerHTML = '';
    };

    // Отправка формы регистрации (AJAX)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorsBox.innerHTML = '';

        const resp = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            window.location.reload();
            return;
        }

        const errors = data.errors || {};
        errorsBox.innerHTML = Object.entries(errors)
            .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
            .join('');
    });

    // Открытие модалки входа
    document.getElementById('openLogin').onclick = () => {
        document.getElementById('openLogin').disabled = true;
        modal.style.display = 'none';
        errorsBox.innerHTML = '';
        loginErrorsBox.innerHTML = '';
        loginModal.style.display = 'block';
    };
    
    // Закрытие модалки входа (кнопка X)
    document.getElementById('closeLogin').onclick = () => {
        loginModal.style.display = 'none';
        modal.style.display = 'none';
        document.getElementById('openLogin').disabled = false;
    };
    
    // Закрытие модалки регистрации (кнопка Close)
    document.getElementById('closeSignupBtn').onclick = () => {
        modal.style.display = 'none';
        loginModal.style.display = 'none';
        document.getElementById('openLogin').disabled = false;
    };

    // Закрытие модалки входа (кнопка Close)
    document.getElementById('closeLoginBtn').onclick = () => {
        loginModal.style.display = 'none';
        modal.style.display = 'none';
        document.getElementById('openLogin').disabled = false;
    };
    
    // Отправка формы входа (AJAX)
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginErrorsBox.innerHTML = '';

        const resp = await fetch(loginForm.action, {
            method: 'POST',
            body: new FormData(loginForm),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            window.location.reload();
            return;
        }

        const errors = data.errors || {};
        loginErrorsBox.innerHTML = Object.entries(errors)
            .map(([field, msgs]) => `<div><b>${field}</b>: ${msgs.join(', ')}</div>`)
            .join('');
    });
</script>

</body>
</html>
